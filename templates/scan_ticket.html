{% extends "admin_layout.html" %}
{% block title %}Scan Ticket{% endblock %}

{% block content %}
<div class="max-w-md mx-auto bg-white p-8 rounded-3xl shadow-lg text-center">
    <h2 class="text-3xl font-bold mb-4">Scan Ticket</h2>
    <!-- File Upload Form -->
    <form method="POST" enctype="multipart/form-data">
        <input type="file" name="qr_image" accept="image/*" class="mb-4">
        <button type="submit" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">Scan Image</button>
    </form>
    <hr class="my-6">
    <button id="liveScanBtn">Scan QR via Camera</button>
<div id="cameraFrame" style="display:none;">
    <video id="video" width="400" height="300" autoplay></video>
    <p id="qrResult"></p>
    <button id="closeCamera">Close Camera</button>
</div>
    <!-- Camera Modal -->
    <div id="camera-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-3xl relative w-96">
            <span id="close-modal" class="absolute top-2 right-4 cursor-pointer text-xl font-bold">&times;</span>
            <h3 class="text-xl font-bold mb-4">Place QR in camera frame</h3>
            <div id="qr-reader" style="width:100%; height:300px;"></div>
            <div id="qr-result" class="mt-4 font-bold text-green-600"></div>
        </div>
    </div>

    {% if ticket %}
        <div class="mt-6 p-4 bg-gray-100 rounded-lg">
            <h3 class="font-bold text-xl">Ticket #{{ ticket.id }}</h3>
            <p>Status: {{ ticket.status }}</p>
            <p>Scans: {{ ticket.scan_count }}</p>
        </div>
    {% endif %}
</div>
<!-- Html5 QR code library -->
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script>
const liveScanBtn = document.getElementById("liveScanBtn");
const cameraFrame = document.getElementById("cameraFrame");
const video = document.getElementById("video");
const qrResult = document.getElementById("qrResult");
const closeCamera = document.getElementById("closeCamera");
let scanning = false;
let stream = null;

liveScanBtn.onclick = async () => {
    cameraFrame.style.display = "block";
    scanning = true;

    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;

    const canvas = document.createElement("canvas");
    const context = canvas.getContext("2d");

    function tick() {
        if (!scanning) return;
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, canvas.width, canvas.height);
            if (code) {
                qrResult.textContent = `QR Detected: ${code.data}`;
                
                // Send QR to server
                fetch("/scan-ticket-live", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ ticket_id: code.data })
                })
                .then(res => res.json())
                .then(data => alert(data.message));

                scanning = false;
                stopCamera();
            }
        }
        requestAnimationFrame(tick);
    }
    tick();
};

function stopCamera() {
    scanning = false;
    cameraFrame.style.display = "none";
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
}

closeCamera.onclick = stopCamera;
</script>

{% endblock %}
