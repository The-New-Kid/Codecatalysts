{% extends "user_layout.html" %}
{% block title %}Book Ticket{% endblock %}

{% block content %}
<h2 class="text-4xl font-bold text-center mb-10 text-purple-700">Book Darshan Ticket</h2>

<div class="max-w-3xl mx-auto bg-white p-8 rounded-3xl shadow-lg">
    <form action="{{ url_for('book_ticket', user_id=user.id) }}" method="POST">
        <!-- Ticket Booker Info -->
        <div class="mb-6">
            <label class="font-semibold text-gray-700">Booker Name</label>
            <input type="text" name="user_name"
                class="w-full mt-2 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400"
                placeholder="Enter booker name" required>
        </div>

        <div class="mb-6">
            <label class="font-semibold text-gray-700">Email</label>
            <input type="email" name="user_email"
                class="w-full mt-2 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400"
                placeholder="Enter email" required>
        </div>

        <div class="mb-6">
            <label class="font-semibold text-gray-700">Mobile Number</label>
            <input type="text" name="mobile_number"
                class="w-full mt-2 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400"
                placeholder="Enter mobile number" required>
        </div>

        <!-- Step 1: Number of Members -->
        <div class="mb-6">
            <label class="font-semibold text-gray-700">Number of Tickets</label>
            <input type="number" id="num_members" name="num_members"
                class="w-full mt-2 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400"
                min="1" value="1" required>
        </div>

        <!-- Step 2: Passenger Details (Dynamic Section) -->
        <div id="passenger_inputs" class="mb-8 space-y-4"></div>

        <!-- Step 3: Slot Selection -->
        <div class="mb-5">
            <label class="font-semibold text-gray-700">Select Slot</label>
            <select name="slot_id"
                class="w-full mt-2 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400"
                required>
                {% for slot in slots %}
                <option value="{{ slot.id }}">
                    {{ slot.slot_type }} | {{ slot.start_time.strftime('%H:%M') }} - {{ slot.end_time.strftime('%H:%M') }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Step 4: Optional Parking -->
        <div class="mb-5">
            <label class="font-semibold text-gray-700">Select Parking (Optional)</label>
            <select name="parking_lot_id"
                class="w-full mt-2 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400">
                <option value="">No Parking</option>
                {% for lot in lots %}
                <option value="{{ lot.id }}">{{ lot.prime_location_name }}</option>
                {% endfor %}
            </select>
        </div>

        <button type="submit"
            class="w-full py-3 bg-gradient-to-r from-purple-500 to-blue-500 text-white font-bold rounded-full shadow-lg hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300">
            Book Ticket
        </button>
    </form>
</div>

<script>
const numInput = document.getElementById('num_members');
const container = document.getElementById('passenger_inputs');

function generatePassengerInputs() {
    container.innerHTML = '';
    const count = parseInt(numInput.value) || 1;

    for (let i = 0; i < count; i++) {
        const div = document.createElement('div');
        div.classList.add('p-4', 'border', 'rounded-xl', 'bg-purple-50', 'shadow-sm');

        div.innerHTML = `
            <h4 class="font-semibold text-purple-700 mb-3">Passenger ${i + 1}</h4>
            <div class="grid grid-cols-2 gap-4 mb-2">
                <input type="text" name="passenger_name[]" placeholder="Passenger Name"
                    class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400" required>
            </div>
            <div class="grid grid-cols-2 gap-4 items-center">
                <input type="text" name="aadhar_number[]" placeholder="Aadhar Number"
                    class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400" required>
                <button type="button" class="send-otp-btn p-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600">Send OTP</button>
            </div>
            <div class="grid grid-cols-2 gap-4 items-center mt-2">
                <input type="text" name="otp[]" placeholder="Enter OTP"
                    class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400" required>
                <button type="button" class="verify-otp-btn p-3 bg-green-500 text-white rounded-lg hover:bg-green-600">Verify OTP</button>
            </div>
            <span class="otp-status text-sm font-semibold"></span>
        `;
        container.appendChild(div);
    }

    setupOtpButtons();
}

function setupOtpButtons() {
    // Send OTP buttons
    container.querySelectorAll('.send-otp-btn').forEach(btn => {
        btn.onclick = async () => {
            const parentCard = btn.closest('.p-4');
            const aadharInput = parentCard.querySelector('input[name="aadhar_number[]"]');
            const aadhar = aadharInput.value.trim();
            if (!aadhar) return alert("Enter Aadhar number!");

            const res = await fetch('/send-otp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ aadhar })
            });
            const data = await res.json();
            alert(data.message);
        };
    });

    // Verify OTP buttons
    // Verify OTP buttons
// Verify OTP buttons
container.querySelectorAll('.verify-otp-btn').forEach(btn => {
    btn.onclick = async () => {
        const parentCard = btn.closest('.p-4');
        const otpInput = parentCard.querySelector('input[name="otp[]"]');
        const aadharInput = parentCard.querySelector('input[name="aadhar_number[]"]');
        const sendBtn = parentCard.querySelector('.send-otp-btn'); // Send OTP button
        const statusSpan = parentCard.querySelector('.otp-status');

        const aadhar = aadharInput.value.trim();
        const otp = otpInput.value.trim();

        if (!otp) return alert("Enter OTP!");

        const res = await fetch('/verify-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ aadhar, otp })
        });

        const data = await res.json();

        if (data.success) {
            statusSpan.textContent = "Verified ✅";
            statusSpan.classList.remove('text-red-600');
            statusSpan.classList.add('text-green-600');

            otpInput.readOnly = true;
            btn.disabled = true;        // Verify OTP button disabled
            sendBtn.style.display = 'none'; // Send OTP button blocked completely
        } else {
            statusSpan.textContent = "OTP Invalid ❌";
            statusSpan.classList.remove('text-green-600');
            statusSpan.classList.add('text-red-600');
        }
    };
});
}
// Initial render
generatePassengerInputs();
numInput.addEventListener('input', generatePassengerInputs);
</script>
{% endblock %}
