<template>
  <Userlayoutnew>
    
    <div class="relative w-full h-[500px] lg:h-[600px] overflow-hidden shadow-2xl">
      <div class="absolute inset-0">
        <img 
            src="/images/somnath10.jpg" 
            alt="Temple Banner" 
            class="w-full h-full object-cover object-center"
        />
        <div class="absolute inset-0 bg-gradient-to-t from-red-900/90 via-red-900/40 to-black/30"></div>
      </div>

      <div class="relative z-10 flex flex-col items-center justify-center h-full text-center px-4" data-aos="fade-up">
        
        <div class="mb-8 animate-fade-in-up">
            <h2 class="text-4xl md:text-6xl font-serif font-bold text-white mb-2 drop-shadow-lg">
            Jai Mahakal, {{ userStore.name || 'Bhakt' }}
            </h2>
            <p class="text-lg md:text-xl text-yellow-100 max-w-2xl mx-auto font-light drop-shadow-md">
            Manage your darshan bookings and parking seva with ease.
            </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 w-full max-w-5xl">
            <RouterLink to="#" class="glass-btn group bg-orange-600 border-none hover:bg-orange-700">
                <div class="icon-circle bg-white text-orange-600">
                    <i data-feather="check-circle" class="w-6 h-6"></i>
                </div>
                <div class="text-left">
                    <span class="block text-sm font-bold text-gray-800 group-hover:text-orange-700">Book Spot</span>
                    <span class="text-xs text-gray-500">Reserve Now</span>
                </div>
            </RouterLink>

            <RouterLink to="/book_darshannew" class="glass-btn group bg-red-700 border-none hover:bg-red-800">
                <div class="icon-circle bg-white text-red-700">
                    <i data-feather="calendar" class="w-6 h-6"></i>
                </div>
                <div class="text-left">
                    <span class="block text-sm font-bold text-gray-800 group-hover:text-red-700">Book Darshan</span>
                    <span class="text-xs text-gray-600">Get Ticket</span>
                </div>
            </RouterLink>
            <!--create book aarti button below this comment-->
            <RouterLink to="#" class="glass-btn group bg-yellow-600 border-none hover:bg-yellow-700">
                <div class="icon-circle bg-white text-yellow-600">
                    <i data-feather="sun" class="w-6 h-6"></i>
                </div>
                <div class="text-left">
                    <span class="block text-sm font-bold text-gray-800 group-hover:text-yellow-700">Book Aarti</span>
                    <span class="text-xs text-gray-600">Divine Experience</span>
                </div>
            </RouterLink>
              <!-- Tatkal Darshan -->
              <div>
                <!-- Before or After time window -->
                <button
                  v-if="!isTatkalOpen"
                  disabled
                  class="glass-btn group bg-gray-400 border-none cursor-not-allowed opacity-60"
                >
                  <div class="icon-circle bg-white text-gray-500">
                    <i data-feather="zap" class="w-6 h-6"></i>
                  </div>
                  <div class="text-left">
                    <span class="block text-sm font-bold text-gray-700">Darshan Tatkal</span>
                    <span class="text-xs text-gray-500">{{ openMessage }}</span>
                  </div>
                </button>

                <!-- During 7‚Äì9 AM -->
                <RouterLink
                  v-else
                  to="/book_darshan_tatkal"
                  class="glass-btn group bg-red-600 border-none hover:bg-red-700"
                >
                  <div class="icon-circle bg-white text-red-600">
                    <i data-feather="zap" class="w-6 h-6"></i>
                  </div>
                  <div class="text-left">
                    <span class="block text-sm font-bold text-gray-800 group-hover:text-red-700">Darshan Tatkal</span>
                    <span class="text-xs text-gray-600">Fast Track Entry</span>
                  </div>
                </RouterLink>
              </div>


              <!-- Tatkal Aarti -->
              <div>
                <button
                  v-if="!isTatkalOpen"
                  disabled
                  class="glass-btn group bg-gray-400 border-none cursor-not-allowed opacity-60"
                >
                  <div class="icon-circle bg-white text-gray-500">
                    <i data-feather="sunrise" class="w-6 h-6"></i>
                  </div>
                  <div class="text-left">
                    <span class="block text-sm font-bold text-gray-700">Aarti Tatkal</span>
                    <span class="text-xs text-gray-500">{{ openMessage }}</span>
                  </div>
                </button>

                <RouterLink
                  v-else
                  to="/book_aarti_tatkal"
                  class="glass-btn group bg-orange-600 border-none hover:bg-orange-700"
                >
                  <div class="icon-circle bg-white text-orange-600">
                    <i data-feather="sunrise" class="w-6 h-6"></i>
                  </div>
                  <div class="text-left">
                    <span class="block text-sm font-bold text-gray-800 group-hover:text-orange-700">Aarti Tatkal</span>
                    <span class="text-xs text-gray-600">Instant Booking</span>
                  </div>
                </RouterLink>
              </div>




        </div>
      </div>
    </div>
<div class="w-full bg-yellow-100 border-b-2 border-yellow-300 overflow-hidden shadow-inner">
      <marquee behavior="scroll" direction="left" scrollamount="10" class="py-3 flex items-center">
        <span class="text-red-800 font-bold text-lg tracking-wide mx-4">
          üîî Tatkal booking for Aarti and Darshan opens daily at 6:00 AM. Please plan your booking accordingly. || Jai Shri Mahakal üôè
        </span>
      </marquee>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
        <h2 class="text-3xl font-serif font-extrabold text-center text-red-800 mb-12" data-aos="fade-up">
            üôè Essential Temple Services
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            
            <div 
                class="service-card" 
                data-aos="fade-right" 
                data-aos-delay="100"
            >
                <div class="p-6">
                    <i data-feather="bell" class="w-8 h-8 text-orange-600 mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">E-Pooja & Rituals</h3>
                    <p class="text-gray-600 mb-4 text-sm">
                        Perform traditional rituals and offerings remotely. Book a *Sankalp* (vow) and receive Prashad at your home.
                    </p>
                    <RouterLink to="#" class="text-orange-600 hover:text-orange-800 font-medium text-sm flex items-center">
                        Book Your Seva <i data-feather="arrow-right" class="w-4 h-4 ml-1"></i>
                    </RouterLink>
                </div>
            </div>

            <div 
                class="service-card" 
                data-aos="fade-up" 
                data-aos-delay="200"
            >
                <div class="p-6">
                    <i data-feather="heart" class="w-8 h-8 text-red-700 mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Temple Donations</h3>
                    <p class="text-gray-600 mb-4 text-sm">
                        Support the temple's maintenance, Annakshetra (food charity), and cultural activities with your generous contribution.
                    </p>
                    <RouterLink to="#" class="text-red-700 hover:text-red-900 font-medium text-sm flex items-center">
                        Donate Now <i data-feather="arrow-right" class="w-4 h-4 ml-1"></i>
                    </RouterLink>
                </div>
                
            </div>
            
            <div 
                class="service-card" 
                data-aos="fade-left" 
                data-aos-delay="300"
            >
                <div class="p-6">
                    <i data-feather="home" class="w-8 h-8 text-purple-600 mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Pilgrim Accommodation</h3>
                    <p class="text-gray-600 mb-4 text-sm">
                        Find comfortable and affordable *Dharamshala* (guesthouse) options near the temple for your stay.
                    </p>
                    <RouterLink to="#" class="text-purple-600 hover:text-purple-800 font-medium text-sm flex items-center">
                        View Stays <i data-feather="arrow-right" class="w-4 h-4 ml-1"></i>
                    </RouterLink>
                </div>
            </div>
        </div>
    </div>


    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        
      <div class="bg-white rounded-xl shadow-xl border-t-4 border-orange-600 overflow-hidden" data-aos="fade-up">
        <div class="p-6 border-b border-gray-100 bg-orange-50 flex items-center justify-between">
            <div>
                <h3 class="text-2xl font-serif font-bold text-red-800">
                Recent Parking History
                </h3>
                <p class="text-sm text-gray-500">Your past and ongoing vehicle sevas</p>
            </div>
            <div class="hidden sm:block">
                <span class="text-3xl">üöó</span>
            </div>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full table-auto">
            <thead class="bg-red-900 text-yellow-50">
              <tr>
                <th class="px-6 py-4 text-left text-sm font-medium uppercase tracking-wider">Location</th>
                <th class="px-6 py-4 text-left text-sm font-medium uppercase tracking-wider">Vehicle</th>
                <th class="px-6 py-4 text-left text-sm font-medium uppercase tracking-wider">Start</th>
                <th class="px-6 py-4 text-left text-sm font-medium uppercase tracking-wider">End</th>
                <th class="px-6 py-4 text-left text-sm font-medium uppercase tracking-wider">Dakshina</th>
                <th class="px-6 py-4 text-left text-sm font-medium uppercase tracking-wider">Action</th>
              </tr>
            </thead>

            <tbody class="divide-y divide-gray-200">
              <tr
                v-for="r in reservations"
                :key="r.id"
                class="hover:bg-orange-50 transition duration-200"
              >
                <td class="px-6 py-4">
                  <span class="font-bold text-gray-800 block">{{ r.prime_location }}</span>
                  <small class="text-gray-500">{{ r.address }}</small>
                </td>
                <td class="px-6 py-4 font-mono text-gray-700">{{ r.vehicle_number || 'N/A' }}</td>
                <td class="px-6 py-4 text-gray-700">{{ r.start_time }}</td>
                <td class="px-6 py-4 text-gray-700">
                  <span v-if="r.end_time">{{ r.end_time }}</span>
                  <span
                    v-else
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"
                  >
                    Ongoing
                  </span>
                </td>
                <td class="px-6 py-4 font-semibold text-red-700">‚Çπ{{ r.cost_per_hour }}</td>
                <td class="px-6 py-4">
                  <button
                    v-if="r.end_time"
                    class="text-gray-400 cursor-not-allowed font-medium text-sm"
                    disabled
                  >
                    Completed
                  </button>
                  <button
                    v-else
                    @click="releaseSpot(r.id)"
                    class="bg-orange-500 text-white px-4 py-1.5 rounded-full text-sm font-medium hover:bg-orange-600 transition shadow-sm"
                  >
                    Release
                  </button>
                </td>
              </tr>
              <tr v-if="reservations.length === 0">
                <td colspan="6" class="px-6 py-12 text-center text-gray-500 italic">
                  No parking seva history found.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-12 pb-24" data-aos="fade-up">
        <div class="bg-red-50 border border-red-200 rounded-xl p-8 md:p-12 text-center shadow-lg">
            <h3 class="text-3xl font-serif font-bold text-red-800 mb-3">
                Need Help with Your Darshan?
            </h3>
            <p class="text-red-700 max-w-3xl mx-auto mb-6">
                Our Seva Kendra is available to assist you with all bookings, parking inquiries, and temple information. Your journey to the divine should be seamless.
            </p>
            <RouterLink 
                to="#" 
                class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-full shadow-sm text-white bg-red-700 hover:bg-red-800 transition duration-150"
            >
                <i data-feather="phone" class="w-5 h-5 mr-2"></i>
                Contact Seva Kendra
            </RouterLink>
        </div>
    </div>


    <footer class="relative w-full overflow-hidden">
        <div class="absolute inset-0">
            <img 
                src="/images/somnath10.jpg" 
                alt="Somnath Temple at Dusk" 
                class="w-full h-full object-cover object-center filter grayscale opacity-40"
            />
            <div class="absolute inset-0 bg-red-900/90 mix-blend-multiply"></div>
        </div>

        <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20 text-center text-white" data-aos="zoom-in">
            <i data-feather="droplet" class="w-10 h-10 text-yellow-400 mx-auto mb-4"></i>
            
            <blockquote class="max-w-4xl mx-auto mb-10">
                <p class="text-2xl md:text-4xl font-serif font-light italic leading-relaxed">
                    "The journey to the Jyotirlinga is the journey within. May the light of Mahakal illuminate your path."
                </p>
            </blockquote>

            <div class="pt-8 border-t border-red-700/50">
                <p class="text-xl font-bold mb-2">Shri Mahakal Trust</p>
                <p class="text-sm text-red-200">
                    Somnath, Gujrat, India 
                    <span class="mx-2">|</span> 
                    E-mail: seva@mahakal.org 
                    <span class="mx-2">|</span> 
                    Phone: +91 0000 12345
                </p>
                <p class="text-xs mt-4 text-red-300/70">
                    ¬© 2025 Mahakal Online Seva. All Rights Reserved.
                </p>
            </div>
        </div>
    </footer>

  </Userlayoutnew>
</template>

<script setup>
import Userlayoutnew from '@/layouts/Userlayoutnew.vue' // UPDATED IMPORT
import { ref, onMounted } from 'vue'
import axios from 'axios'
import AOS from 'aos'
import 'aos/dist/aos.css'
import { useUserStore } from '@/stores/user'
import feather from 'feather-icons'

const userStore = useUserStore()
const reservations = ref([])

onMounted(async () => {
  feather.replace()
  AOS.init({ duration: 800, once: true })

  const id = userStore.id || sessionStorage.getItem('user_id')
  if (!id) return

  try {
    // Note: Use a more robust way to handle the API base URL in a real app
    const res = await axios.get(`http://127.0.0.1:5000/api/user/dashboard/${id}`)
    userStore.name = res.data.user.name
    reservations.value = res.data.reservations
  } catch (err) {
    console.error('Error loading dashboard:', err)
  }
})

async function releaseSpot(reservationId) {
  try {
    await axios.post(`http://127.0.0.1:5000/api/release/${reservationId}`)
    // Optimistically update the UI after successful release
    const index = reservations.value.findIndex(r => r.id === reservationId);
    if (index !== -1) {
        // You might want to update the end_time property here instead of filtering it out,
        // but based on your original logic, filtering/removing is fine.
        reservations.value = reservations.value.filter((r) => r.id !== reservationId)
    }
    // A real application would show a confirmation toast/notification here.
  } catch (err) {
    console.error('Error releasing spot:', err)
    // A real application would show an error toast/notification here.
  }
}


const isTatkalOpen = ref(false);
const openMessage = ref("");
function checkTatkalWindow() {
  const now = new Date();
  const hour = now.getHours();
  const minute = now.getMinutes();

  const current = hour * 60 + minute;      // convert time to minutes
  const start = 7 * 60;                   // 7 AM
  const end = 9 * 60;                     // 9 AM

  if (current >= start && current < end) {
    isTatkalOpen.value = true;
    openMessage.value = "Open Now";
  } 
  else if (current < start) {
    isTatkalOpen.value = false;
    openMessage.value = "Opens at 7:00 AM";
  } 
  else {
    isTatkalOpen.value = false;
    openMessage.value = "Closed at 9:00 AM";
  }
}

checkTatkalWindow();
setInterval(checkTatkalWindow, 60000); // update every minute





</script>

<style scoped>
/* Glassmorphism Button Style - Existing */
.glass-btn {
    display: flex;
    align-items: center;
    gap: 12px;
    background: rgba(255, 255, 255, 0.95); 
    padding: 12px 20px;
    border-radius: 12px;
    /* Added subtle glass effect */
    backdrop-filter: blur(2px); 
    -webkit-backdrop-filter: blur(2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transition: all 0.3s ease;
    text-decoration: none;
    cursor: pointer;
}

.glass-btn:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
}

.icon-circle {
    width: 40px;
    height: 40px;
    background-color: #fff7ed; /* Light Orange Background */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

/* New Hoverable Service Card Style */
.service-card {
    background-color: white;
    border-radius: 1rem;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.04);
    transition: all 0.3s ease-in-out;
    border: 1px solid #f3f4f6;
}

.service-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 30px -10px rgba(0, 0, 0, 0.2);
    border-color: #f97316; /* Orange border on hover */
}
</style>